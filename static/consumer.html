<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQ Consumer</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; background: #f8f9fa; }
        #peek-list { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 15px; height: 300px; overflow-y: auto; }
        .msg { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .consume-btn { background: #28a745; border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        #log { margin-top: 20px; background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 4px; height: 200px; overflow-y: auto; }
        .log-entry { padding: 6px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<h1>Queue Consumer</h1>

<h3>Peeked Messages</h3>
<div id="peek-list"></div>

<h3>Consume Log</h3>
<div id="log"></div>

<script>
const MQ = "http://localhost:1337";
const peekBox = document.getElementById("peek-list");
const logBox = document.getElementById("log");

async function refreshPeek() {
    const res = await fetch(`${MQ}/peek`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ count: 10 })
    });

    const messages = await res.json();
    renderPeek(messages);
}

function renderPeek(list) {
    peekBox.innerHTML = "";

    if (!Array.isArray(list) || list.length === 0) {
        peekBox.innerHTML = `<div>No messages</div>`;
        return;
    }

    list.forEach(msg => {
        const div = document.createElement("div");
        div.className = "msg";
        div.innerHTML = `
            <span>"${msg.body}"<br><small>${msg.id}</small></span>
            <button class="consume-btn">Consume</button>
        `;

        div.querySelector(".consume-btn").onclick = () => consumeMessage();
        peekBox.appendChild(div);
    });
}

// Consume = call /get and delete
async function consumeMessage() {
    const res = await fetch(`${MQ}/get`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ count: 1 })
    });

    const arr = await res.json();
    if (!Array.isArray(arr) || arr.length === 0) return;

    const msg = arr[0];

    await fetch(`${MQ}/delete`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids: [msg.id] })
    });

    log(`Consumed: "${msg.body}" (${msg.id})`);
    refreshPeek();
}


function log(text) {
    const div = document.createElement("div");
    div.className = "log-entry";
    div.textContent = text;
    logBox.prepend(div);
}

setInterval(refreshPeek, 1500);
refreshPeek();
</script>

</body>
</html>
